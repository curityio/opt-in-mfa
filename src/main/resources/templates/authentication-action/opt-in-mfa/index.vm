#*
 *  Copyright 2020 Curity AB
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *###

#parse("fragments/icon-mappings")

#set($title = "Choose second factor")

#set ($page_symbol = $page_symbol_authenticate_desktop)

#define ($_body)

    #if($step == "showCodes")
        <p>
            Print these codes or save them in a safe place. If you ever lose access to the device you've just configured
            as your second factor you will need these codes to regain access to your account.
        </p>
        <div class="form-field">
            #foreach($code in $scratchCodes)
                <p>$code</p>
            #end
        </div>
        <div class="form-field">
            <a href="$_actionUrl/confirm" class="button button-primary button-fullwidth button-social">
                I confirm that I saved the codes
            </a>
        </div>
    #else
        <form action="$_actionUrl/chooseFactor" method="POST" id="secondFactorForm">
            #if($isFirstChoiceOfSecondFactor == true)
                <p>Choose the second factor that you will from now on use to verify the login.</p>
                <p>Give your second factor a name, e.g. "Authenticator on my private moible", "company key 1", etc.</p>
                <div class="form-field">
                    <label for="secondFactorName" >Name for the second factor</label>
                    <input type="text" name="secondFactorName" id="secondFactorName" class="full-width block mb1 field-light"/>
                </div>
            #else
                <p>Select the second factor you want to use to verify the login.</p>
            #end
            #foreach($_authenticatorMapItem in $authenticators)
                <div class="form-field mb1">
                    <button type="submit" id="$_authenticatorMapItem.acr" class="button-secondary-factor button button-primary button-fullwidth button-social button-$_authenticatorMapItem.type">
                        <i class="icon #iconClassName($_authenticatorMapItem.type)"></i>
                        $_authenticatorMapItem.description
                    </button>
                </div>
            #end
            <input type="hidden" id="secondFactor" name="secondFactor" value="" />
            <input type="checkbox" id="rememberChoice" name="rememberChoice" /><label for="rememberChoice">Remember my choice of the second factor on this browser for $rememberMyChoiceDays days.</label>

            #if($isFirstChoiceOfSecondFactor != true)
                <div class="form-field mb1">
                    <a href="$_actionUrl/register">Add / remove a second factor</a>
                </div>
                <div class="form-field">
                    <a href="$_actionUrl/emergencyRegister">Register another factor with a recovery code</a>
                </div>
            #end
        </form>

        #parse("fragments/jquery")

        <script type="text/javascript" $!nonceAttr>
            jQuery(document).ready(function ($) {
                $(".button-secondary-factor").on("click", function(e) {
                    $("#secondFactor").val(this.id);
                });
            });
        </script>
    #end
#end

#parse("layouts/default")
